name: Rb m/26S Non-Stop Monitor

on:
  schedule:
    # 5時間ごとに起動 (UTC 0, 5, 10, 15, 20時...)
    # 日本時間(JST)では 9, 14, 19, 0, 5時... に相当
    - cron: '0 */5 * * *'
  workflow_dispatch: # ボタンから手動で即時起動可能

jobs:
  run-periodic-bot:
    runs-on: ubuntu-latest
    
    # 記憶（last_video_id.txt）と設定（config.json）をリポジトリに保存するための書き込み権限
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # 最新の履歴を反映させるため、常に最新を取得
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install discord.py feedparser

      - name: Run Bot
        env:
          # GitHub Secretsに保存したトークンを環境変数に渡す
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        run: python main.py

      - name: Sync Memory and Config to Repository
        # プログラム終了後（5.5時間後）、動画IDと管理者による設定をGitにコミットして保存
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 動画IDと設定ファイルの両方をステージングに追加
          git add last_video_id.txt config.json
          
          # 変更（動画更新 or スラッシュコマンドによる設定変更）がある場合のみコミット
          if ! git diff --cached --exit-code; then
            git commit -m "docs: sync last video id and config [skip ci]"
            git push
          else
            echo "No changes in data files. Skipping push."
          fi
