name: Rb m/26S Strategic Monitor

on:
  schedule:
    # 5æ™‚é–“ã”ã¨ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†èµ·å‹• (UTC 0, 5, 10, 15, 20æ™‚...)
    # å¸¸ã«æœ€æ–°ã®ãƒ—ãƒ­ã‚»ã‚¹ã§5åˆ†é–“éš”ã®ç›£è¦–ã‚’ç¶™ç¶šã•ã›ã¾ã™
    - cron: '0 */5 * * *'
  workflow_dispatch: # æ‰‹å‹•ã§å³æ™‚èµ·å‹•ã™ã‚‹ãŸã‚ã®ãƒœã‚¿ãƒ³

jobs:
  run-monitor:
    runs-on: ubuntu-latest
    # 5æ™‚é–“ã®é€£ç¶šç¨¼åƒã‚’ä¿è¨¼ã—ã¤ã¤ã€GitHubå´ã®åˆ¶é™(6æ™‚é–“)ã®å‰ã«å®‰å…¨ã«çµ‚äº†
    timeout-minutes: 310 
    
    permissions:
      contents: write # ãƒ­ã‚°ã®è‡ªå‹•ä¿å­˜ã«å¿…è¦

    steps:
      - name: ðŸ“¦ ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ Pythonç’°å¢ƒã®æ§‹ç¯‰ (3.11)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip' # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦èµ·å‹•é€Ÿåº¦ã‚’å‘ä¸Š

      - name: ðŸ› ï¸ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install discord.py feedparser requests
          fi

      - name: ðŸš€ Rb m/26S èµ·å‹• (5æ™‚é–“å¸¸é§ãƒ¢ãƒ¼ãƒ‰)
        env:
          # ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒã«ä¸å¯æ¬ ãªSecrets
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ—¥æœ¬ã«è¨­å®šï¼ˆãƒ­ã‚°ç”¨ï¼‰
          TZ: "Asia/Tokyo"
        # continue-on-error: true ã«ã‚ˆã‚Šã€çµ‚äº†æ™‚ã® git push ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
        continue-on-error: true 
        run: python main.py

      - name: ðŸ’¾ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã®åŒæœŸ (Git Push)
        # ãƒœãƒƒãƒˆçµ‚äº†ç›´å‰ã«ã€ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ´»å‹•è¨˜éŒ²ã‚’ãƒªãƒã‚¸ãƒˆãƒªã¸ä¿å­˜
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚Œã°è¿½åŠ 
          git add last_video_id.txt config.json logs/*.log 2>/dev/null || true
          
          if ! git diff --cached --exit-code; then
            git commit -m "docs: system activity log synchronized [skip ci]"
            git push
          else
            echo "No status changes detected. Skipping sync."
          fi
