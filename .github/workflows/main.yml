name: Rb m/26S Non-Stop Monitor

on:
  schedule:
    # 5時間ごとに起動 (UTC 0, 5, 10, 15, 20時...)
    # 日本時間(JST)では 9, 14, 19, 0, 5時... に相当
    - cron: '0 */5 * * *'
  workflow_dispatch: # 手動起動用ボタン

jobs:
  run-periodic-bot:
    runs-on: ubuntu-latest
    
    # 権限設定: データの自動保存(git push)に必要
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # requirements.txtが存在する場合のみ、一括インストールを実行
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # 予備的なフォールバック（もしファイルが読み込めない場合）
            pip install discord.py feedparser pytz
          fi
          # インストール済みリストを表示（デバッグ用）
          pip list

      - name: Run Bot
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        # 実行中に万が一エラーが起きても、次の「データ同期」ステップへ進むように設定
        continue-on-error: true
        run: python main.py

      - name: Sync Memory and Config to Repository
        # プログラムが終了した際、最新の状態をリポジトリへ保存
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 存在する可能性のある全データファイルをステージング
          # ファイルが存在しなくてもエラーにならないように設定
          git add last_video_id.txt config.json logs/*.log || true
          
          # 変更がある場合のみコミットとプッシュ
          if ! git diff --cached --exit-code; then
            git commit -m "docs: sync system data and logs [skip ci]"
            git push
          else
            echo "No changes in data files. Skipping push."
          fi
